import geopandas as gpd
import pandas as pd
from shapely.geometry import Point

# 1. 加载华盛顿 DC 的 Wards GeoJSON 数据
wards = gpd.read_file("/Users/arthurtran/Library/CloudStorage/OneDrive-Personnel/Cours/Exploration & Visualisation Données/Projet/BikeShare_Washington/data/map.json")

# 2. 加载自行车停靠点数据
stations = pd.read_csv("/Users/arthurtran/Library/CloudStorage/OneDrive-Personnel/Cours/Exploration & Visualisation Données/Projet/BikeShare_Washington/output/md_gbfs_st_information.csv")

# 3. 创建 Geometries（点数据）
# 使用 Shapely 的 Point 对经纬度生成几何点
stations['geometry'] = stations.apply(lambda row: Point(row['longitude'], row['latitude']), axis=1)
stations_gdf = gpd.GeoDataFrame(stations, geometry='geometry', crs="EPSG:4326")

# Vérifiez que les géométries sont valides
stations_gdf = stations_gdf[stations_gdf.is_valid]
wards = wards[wards.is_valid]

# Assurez-vous que les projections sont compatibles
wards = wards.to_crs(stations_gdf.crs)

# 4. 空间匹配：将停靠点与 Wards 数据进行匹配
# 使用空间连接 (spatial join) avec une tolérance
stations_with_wards = gpd.sjoin_nearest(stations_gdf, wards, how="left", distance_col="distance")

# 5. 保存结果为新的 CSV 文件
# 提取所需字段，如区名称 (ward_name) 或编号 (ward_id)
output_columns = ['station_id', 'name', 'latitude', 'longitude', 'ward']
stations_with_wards['ward'] = stations_with_wards['LABEL']  # 假设 GeoJSON 中的区名称字段为 'LABEL'
stations_with_wards[output_columns].to_csv("/Users/arthurtran/Library/CloudStorage/OneDrive-Personnel/Cours/Exploration & Visualisation Données/Projet/BikeShare_Washington/data/datastations_with_wards.csv", index=False)